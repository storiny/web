"use strict";(self.webpackChunk_storiny_monorepo=self.webpackChunk_storiny_monorepo||[]).push([[40947],{"./packages/editor/src/atoms/awareness/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>awareness_atom});const awareness_atom=(0,__webpack_require__("./node_modules/jotai/esm/vanilla.mjs").eU)(null)},"./packages/editor/src/atoms/history/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Ac:()=>can_redo_atom,UL:()=>can_undo_atom,l:()=>undo_manager_atom});var jotai__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/jotai/esm/vanilla.mjs");const can_undo_atom=(0,jotai__WEBPACK_IMPORTED_MODULE_0__.eU)(!1),can_redo_atom=(0,jotai__WEBPACK_IMPORTED_MODULE_0__.eU)(!1),undo_manager_atom=(0,jotai__WEBPACK_IMPORTED_MODULE_0__.eU)(null)},"./packages/editor/src/plugins/collaboration/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>collaboration});var LexicalComposerContext_prod=__webpack_require__("./node_modules/@lexical/react/LexicalComposerContext.prod.mjs"),invert_min=__webpack_require__("./node_modules/invert-color/lib/invert.min.js"),invert_min_default=__webpack_require__.n(invert_min),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),selectors=__webpack_require__("./packages/ui/src/redux/features/auth/selectors.ts"),hooks=__webpack_require__("./packages/ui/src/redux/hooks/index.ts"),jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),esm_react=__webpack_require__("./node_modules/jotai/esm/react.mjs"),Lexical_prod=__webpack_require__("./node_modules/lexical/Lexical.prod.mjs"),react_dom=__webpack_require__("./node_modules/next/dist/compiled/react-dom/index.js"),yjs=__webpack_require__("./node_modules/yjs/dist/yjs.mjs"),atoms_doc_status=__webpack_require__("./packages/editor/src/atoms/doc-status/index.ts"),awareness=__webpack_require__("./packages/editor/src/atoms/awareness/index.ts"),bindings=__webpack_require__("./packages/editor/src/collaboration/bindings/index.ts");const set_local_state_focus=({provider,focusing,...rest})=>{const{awareness}=provider;let local_state=awareness.getLocalState();null===local_state&&(local_state={...rest,focusing,anchor_pos:null,focus_pos:null}),local_state.focusing=focusing,awareness.setLocalState(local_state)};var sync_cursor_positions=__webpack_require__("./packages/editor/src/utils/sync-cursor-positions/index.ts"),nodes_text=__webpack_require__("./packages/editor/src/collaboration/nodes/text/index.ts"),sync_lexical_selection_to_yjs=__webpack_require__("./packages/editor/src/utils/sync-lexical-selection-to-yjs/index.ts");const sync_lexical_update_to_yjs=({curr_editor_state,prev_editor_state,tags,normalized_nodes,dirty_leaves,dirty_elements,binding,provider,role})=>{((binding,fn)=>{binding.doc.transact(fn,binding)})(binding,(()=>{curr_editor_state.read((()=>{if(tags.has("collaboration")||tags.has("historic"))normalized_nodes.size>0&&((binding,normalized_nodes)=>{const normalized_nodes_keys=Array.from(normalized_nodes),collab_node_map=binding.collab_node_map,merged_nodes=[];for(let i=0;i<normalized_nodes_keys.length;i++){const node_key=normalized_nodes_keys[i],lexical_node=(0,Lexical_prod.ns)(node_key),collab_node=collab_node_map.get(node_key);if(collab_node instanceof nodes_text.D)if((0,Lexical_prod.kF)(lexical_node))merged_nodes.push([collab_node,lexical_node.__text]);else{const offset=collab_node.get_offset();if(-1===offset)continue;const parent=collab_node._parent;collab_node._normalized=!0,parent._xml_text.delete(offset,1),collab_node_map.delete(node_key);const parent_children=parent._children,index=parent_children.indexOf(collab_node);parent_children.splice(index,1)}}for(let i=0;i<merged_nodes.length;i++){const[collab_node,text]=merged_nodes[i];collab_node instanceof nodes_text.D&&"string"==typeof text&&(collab_node._text=text)}})(binding,normalized_nodes);else{if(dirty_elements.has("root")){const prev_node_map=prev_editor_state._nodeMap,next_lexical_root=(0,Lexical_prod.Ni)(),collab_root=binding.root;collab_root.sync_properties_from_lexical(binding,next_lexical_root,prev_node_map),collab_root.sync_children_from_lexical(binding,next_lexical_root,prev_node_map,dirty_elements,dirty_leaves)}if("viewer"!==role){const selection=(0,Lexical_prod.vJ)(),prev_selection=prev_editor_state._selection;(0,sync_lexical_selection_to_yjs.x)(binding,provider,prev_selection,selection)}}}))}))};var sync_yjs_changes_to_lexical=__webpack_require__("./packages/editor/src/utils/sync-yjs-changes-to-lexical/index.ts");const ERROR_CODE_TO_DOC_STATUS_MAP={3001:atoms_doc_status.o.join_missing_story,3002:atoms_doc_status.o.join_realm_full,3003:atoms_doc_status.o.join_unauthorized,3004:atoms_doc_status.o.join_unauthorized,3005:atoms_doc_status.o.doc_corrupted,4e3:atoms_doc_status.o.internal_error},DESTROY_REASON_TO_DOC_STATUS_MAP={story_published:atoms_doc_status.o.published,story_unpublished:atoms_doc_status.o.unpublished,story_deleted:atoms_doc_status.o.deleted,lifetime_exceeded:atoms_doc_status.o.lifetime_exceeded,doc_overloaded:atoms_doc_status.o.overloaded,internal:atoms_doc_status.o.internal_error},use_yjs_collaboration=({doc_map,provider,excluded_properties,should_bootstrap,local_state,role})=>{const[editor]=(0,LexicalComposerContext_prod.DF)(),is_reloading_doc=react.useRef(!1),connected_once_ref=react.useRef(!1),[doc_status,set_doc_status]=(0,esm_react.fp)(atoms_doc_status.G),set_awareness=(0,esm_react.Xr)(awareness.c),[doc,set_doc]=react.useState(doc_map.get("main")),binding=react.useMemo((()=>(0,bindings.H)(editor,doc,doc_map,excluded_properties)),[doc,doc_map,editor,excluded_properties]),connect=react.useCallback((()=>{provider.connect()}),[provider]),disconnect=react.useCallback((()=>{try{provider.disconnect()}catch(e){}}),[provider]);react.useEffect((()=>{const{root}=binding,{awareness}=provider,handle_status=({status})=>{set_doc_status((prev_value=>"connecting"===status?connected_once_ref.current?atoms_doc_status.o.reconnecting:atoms_doc_status.o.connecting:"connected"===status?atoms_doc_status.o.connected:[atoms_doc_status.o.connecting,atoms_doc_status.o.connected,atoms_doc_status.o.reconnecting,atoms_doc_status.o.syncing,atoms_doc_status.o.synced].includes(prev_value)?atoms_doc_status.o.disconnected:prev_value)),"connected"===status&&(connected_once_ref.current=!0)},handle_auth=()=>{set_doc_status(atoms_doc_status.o.join_unauthorized)},handle_sync=is_synced=>{should_bootstrap&&is_synced&&root.is_empty()&&0===root._xml_text._length&&!is_reloading_doc.current&&(editor=>{editor.update((()=>{const root=(0,Lexical_prod.Ni)();if(root.isEmpty()){const paragraph=(0,Lexical_prod.lJ)();root.append(paragraph);const{activeElement:active_element}=document;(null!==(0,Lexical_prod.vJ)()||null!==active_element&&active_element===editor.getRootElement())&&paragraph.select()}}),{tag:"history-merge"})})(editor),set_doc_status(atoms_doc_status.o.synced),is_reloading_doc.current=!1},handle_reload=next_doc=>{((editor,binding)=>{if(editor.update((()=>{const root=(0,Lexical_prod.Ni)();root.clear(),root.select()}),{tag:"skip-collab"}),null==binding.cursors)return;const cursors=binding.cursors,cursors_container=binding.cursors_container;if(null==cursors||null==cursors_container)return;const cursors_arr=Array.from(cursors.values());for(let i=0;i<cursors_arr.length;i++){const selection=cursors_arr[i].selection;if(selection&&null!=selection.selections){const selections=selection.selections;for(let j=0;j<selections.length;j++)cursors_container.removeChild(selections[i])}}})(editor,binding),set_doc(next_doc),doc_map.set("main",next_doc),set_doc_status(atoms_doc_status.o.syncing),is_reloading_doc.current=!0},handle_awareness_update=()=>{(0,sync_cursor_positions.q)(binding,provider)},handle_internal_message=(slug,reason)=>{var _DESTROY_REASON_TO_DOC_STATUS_MAP_reason;if("destroy"===slug)provider.destroy(),set_doc_status(null!==(_DESTROY_REASON_TO_DOC_STATUS_MAP_reason=DESTROY_REASON_TO_DOC_STATUS_MAP[reason])&&void 0!==_DESTROY_REASON_TO_DOC_STATUS_MAP_reason?_DESTROY_REASON_TO_DOC_STATUS_MAP_reason:atoms_doc_status.o.internal_error);else if("role_update"===slug){const[user_id,next_role]=reason.split(":");local_state.user_id===user_id&&(provider.destroy(),set_doc_status("editor"===next_role?atoms_doc_status.o.role_upgraded:atoms_doc_status.o.role_downgraded))}else if("peer_remove"===slug){const[user_id]=reason.split(":");local_state.user_id===user_id&&(provider.destroy(),set_doc_status(atoms_doc_status.o.peer_removed))}},handle_stale=()=>{set_doc_status(atoms_doc_status.o.stale_peer)},handle_connection_close=event=>{const error_code=event.code;var _ERROR_CODE_TO_DOC_STATUS_MAP_error_code;set_doc_status(null!==(_ERROR_CODE_TO_DOC_STATUS_MAP_error_code=ERROR_CODE_TO_DOC_STATUS_MAP[error_code])&&void 0!==_ERROR_CODE_TO_DOC_STATUS_MAP_error_code?_ERROR_CODE_TO_DOC_STATUS_MAP_error_code:atoms_doc_status.o.internal_error)},handle_connection_error=()=>{[atoms_doc_status.o.connecting,atoms_doc_status.o.connected,atoms_doc_status.o.reconnecting,atoms_doc_status.o.syncing,atoms_doc_status.o.synced].includes(doc_status)&&set_doc_status(atoms_doc_status.o.disconnected)};set_awareness(awareness),(({provider,...rest})=>{provider.awareness.setLocalState({...rest,anchor_pos:null,focus_pos:null})})({...local_state,provider,focusing:document.activeElement===editor.getRootElement(),awareness_data:local_state.awareness_data||{}}),provider.on("reload",handle_reload),provider.on("status",handle_status),provider.on("sync",handle_sync),provider.on("auth",handle_auth),provider.on("stale",handle_stale),provider.on("internal-message",handle_internal_message),provider.on("connection-close",handle_connection_close),provider.on("connection-error",handle_connection_error),awareness.on("update",handle_awareness_update);const on_yjs_tree_changes=(events,transaction)=>{const origin=transaction.origin;if(origin!==binding){const is_from_undo_manager=origin instanceof yjs.ad;(0,sync_yjs_changes_to_lexical.s)({binding,provider,events,is_from_undo_manager})}};root.get_shared_type().observeDeep(on_yjs_tree_changes);const remove_listener=editor.registerUpdateListener((({prevEditorState:prev_editor_state,editorState:curr_editor_state,dirtyLeaves:dirty_leaves,dirtyElements:dirty_elements,normalizedNodes:normalized_nodes,tags})=>{tags.has("skip-collab")||sync_lexical_update_to_yjs({binding,provider,dirty_elements,dirty_leaves,tags,normalized_nodes,prev_editor_state,curr_editor_state,role})}));return connect(),()=>{is_reloading_doc.current||disconnect(),provider.off("reload",handle_reload),provider.off("status",handle_status),provider.off("sync",handle_sync),provider.off("auth",handle_auth),provider.off("stale",handle_stale),provider.off("internal-message",handle_internal_message),provider.off("connection-close",handle_connection_close),provider.off("connection-error",handle_connection_error),awareness.off("update",handle_awareness_update),root.get_shared_type().unobserveDeep(on_yjs_tree_changes),doc_map.delete("main"),remove_listener()}}),[]);return[react.useMemo((()=>(0,react_dom.createPortal)((0,jsx_runtime.jsx)("div",{"aria-hidden":!0,ref:element=>{binding.cursors_container=element}}),document.body)),[binding]),binding]};var LexicalUtils_prod=__webpack_require__("./node_modules/@lexical/utils/LexicalUtils.prod.mjs");var atoms_history=__webpack_require__("./packages/editor/src/atoms/history/index.ts");const use_yjs_history=(editor,binding)=>{const set_undo_manager=(0,esm_react.Xr)(atoms_history.l),undo_manager=react.useMemo((()=>((binding,root)=>new yjs.ad(root,{trackedOrigins:new Set([binding,null])}))(binding,binding.root.get_shared_type())),[binding]);return react.useEffect((()=>{set_undo_manager(undo_manager)}),[set_undo_manager,undo_manager]),react.useEffect((()=>(0,LexicalUtils_prod.Sd)(editor.registerCommand(Lexical_prod.ZK,(()=>(undo_manager.undo(),!0)),Lexical_prod.jZ),editor.registerCommand(Lexical_prod.V3,(()=>(undo_manager.redo(),!0)),Lexical_prod.jZ))),[editor,undo_manager]),react.useEffect((()=>{const update_undo_redo_states=()=>{editor.dispatchCommand(Lexical_prod.Kf,undo_manager.undoStack.length>0),editor.dispatchCommand(Lexical_prod.WW,undo_manager.redoStack.length>0)};return undo_manager.on("stack-item-added",update_undo_redo_states),undo_manager.on("stack-item-popped",update_undo_redo_states),undo_manager.on("stack-cleared",update_undo_redo_states),()=>{undo_manager.off("stack-item-added",update_undo_redo_states),undo_manager.off("stack-item-popped",update_undo_redo_states),undo_manager.off("stack-cleared",update_undo_redo_states)}}),[editor,undo_manager]),react.useCallback((()=>{undo_manager.clear()}),[undo_manager])};var dev_log=__webpack_require__("./packages/shared/src/utils/dev-log/index.ts"),broadcastchannel=__webpack_require__("./node_modules/lib0/broadcastchannel.js"),decoding=__webpack_require__("./node_modules/lib0/decoding.js"),encoding=__webpack_require__("./node_modules/lib0/encoding.js"),url=__webpack_require__("./node_modules/lib0/url.js"),auth=__webpack_require__("./node_modules/y-protocols/auth.js"),y_protocols_awareness=__webpack_require__("./node_modules/y-protocols/awareness.js"),sync=__webpack_require__("./node_modules/y-protocols/sync.js"),process=__webpack_require__("./node_modules/process/browser.js");const MESSAGE_HANDLERS=[];MESSAGE_HANDLERS[0]=(encoder,decoder,provider,emit_synced)=>{encoding.zd(encoder,0);const sync_message_type=sync.VU(decoder,encoder,provider.doc,provider);emit_synced&&sync_message_type===sync.Zg&&!provider.synced&&(provider.synced=!0)},MESSAGE_HANDLERS[3]=(encoder,_,provider)=>{encoding.zd(encoder,1),encoding.Gu(encoder,y_protocols_awareness.X3(provider.awareness,Array.from(provider.awareness.getStates().keys())))},MESSAGE_HANDLERS[1]=(_,decoder,provider)=>{y_protocols_awareness.tQ(provider.awareness,decoding.bo(decoder),provider)},MESSAGE_HANDLERS[2]=(_,decoder,provider)=>{auth.gU(decoder,provider.doc,((_,reason)=>provider.emit("auth",[reason])))},MESSAGE_HANDLERS[4]=(_,decoder,provider)=>{const event_message=decoding.t3(decoder),[slug,...rest]=event_message.split(":");provider.emit("internal-message",[slug,(rest||[]).join(":")])};const read_message=(provider,buf,emit_synced)=>{const decoder=decoding.$C(buf),encoder=encoding.xv(),message_type=decoding.cw(decoder),message_handler=provider.message_handlers[message_type];return message_handler?message_handler(encoder,decoder,provider,emit_synced,message_type):dev_log.y.error("Unable to compute the message"),encoder},setup_ws=provider=>{if(provider.should_connect&&null===provider.ws){const websocket=new provider.ws_polyfill(provider.url);websocket.binaryType="arraybuffer",provider.ws=websocket,provider.wsconnecting=!0,provider.wsconnected=!1,provider.synced=!1,websocket.onmessage=event=>{provider.ws_last_message_received=Date.now();const encoder=read_message(provider,new Uint8Array(event.data),!0);encoding.Bw(encoder)>1&&websocket.send(encoding.Fo(encoder))},websocket.onerror=event=>{provider.emit("connection-error",[event,provider])},websocket.onclose=event=>{provider.emit("connection-close",[event,provider]),provider.ws=null,provider.wsconnecting=!1;process.env.STORYBOOK_FLAG;provider.wsconnected?(provider.wsconnected=!1,provider.synced=!1,y_protocols_awareness._g(provider.awareness,Array.from(provider.awareness.getStates().keys()).filter((client=>client!==provider.doc.clientID)),provider),provider.emit("status",[{status:"disconnected"}])):event.code<3e3&&1006!==event.code&&provider.ws_unsuccessful_reconnects++,event.code<3e3&&1006!==event.code&&setTimeout(setup_ws,Math.min(100*Math.pow(2,provider.ws_unsuccessful_reconnects),provider.max_backoff_time),provider)},websocket.onopen=()=>{provider.ws_last_message_received=Date.now(),provider.wsconnecting=!1,provider.wsconnected=!0,provider.ws_unsuccessful_reconnects=0,provider.emit("status",[{status:"connected"}]);const encoder=encoding.xv();if(encoding.zd(encoder,0),sync.ue(encoder,provider.doc),websocket.send(encoding.Fo(encoder)),null!==provider.awareness.getLocalState()){const encoder_awareness_state=encoding.xv();encoding.zd(encoder_awareness_state,1),encoding.Gu(encoder_awareness_state,y_protocols_awareness.X3(provider.awareness,[provider.doc.clientID])),websocket.send(encoding.Fo(encoder_awareness_state))}},provider.emit("status",[{status:"connecting"}])}},broadcast_message=(provider,buf)=>{const ws=provider.ws;provider.wsconnected&&ws&&ws.readyState===ws.OPEN&&ws.send(buf),provider.bcconnected&&(0,broadcastchannel.mk)(provider.bc_channel,buf,provider)};class WebsocketProvider{get synced(){return this._synced}set synced(state){this._synced!==state&&(this._synced=state,this.emit("synced",[state]),this.emit("sync",[state]))}emit(name,args){return Array.from((this.observers.get(name)||new Map).values()).forEach((fn=>fn(...args)))}destroy(){0!==this.resync_interval&&clearInterval(this.resync_interval),clearInterval(this.check_interval),this.disconnect(),this.awareness.off("update",this.awareness_update_handler),this.doc.off("update",this.update_handler),this.observers=new Map}connect_bc(){if(this.disable_bc)return;this.bcconnected||((0,broadcastchannel.B1)(this.bc_channel,this.bc_subscriber),this.bcconnected=!0);const encoder_sync=encoding.xv();encoding.zd(encoder_sync,0),sync.ue(encoder_sync,this.doc),(0,broadcastchannel.mk)(this.bc_channel,encoding.Fo(encoder_sync),this);const encoder_state=encoding.xv();encoding.zd(encoder_state,0),sync.nh(encoder_state,this.doc),(0,broadcastchannel.mk)(this.bc_channel,encoding.Fo(encoder_state),this);const encoder_awareness_query=encoding.xv();encoding.zd(encoder_awareness_query,3),(0,broadcastchannel.mk)(this.bc_channel,encoding.Fo(encoder_awareness_query),this);const encoder_awareness_state=encoding.xv();encoding.zd(encoder_awareness_state,1),encoding.Gu(encoder_awareness_state,y_protocols_awareness.X3(this.awareness,[this.doc.clientID])),(0,broadcastchannel.mk)(this.bc_channel,encoding.Fo(encoder_awareness_state),this)}disconnect_bc(){const encoder=encoding.xv();encoding.zd(encoder,1),encoding.Gu(encoder,y_protocols_awareness.X3(this.awareness,[this.doc.clientID],new Map)),broadcast_message(this,encoding.Fo(encoder)),this.bcconnected&&((0,broadcastchannel.al)(this.bc_channel,this.bc_subscriber),this.bcconnected=!1)}disconnect(){this.should_connect=!1,this.disconnect_bc(),null!==this.ws&&(this.ws.close(),this.ws=null)}connect(){this.should_connect=!0,this.wsconnected||this.wsconnecting||null!==this.ws||(setup_ws(this),this.connect_bc())}constructor(server_url,roomname,doc,{connect=!0,awareness=new y_protocols_awareness.ww(doc),params={},ws_polyfill=WebSocket,resync_interval=-1,max_backoff_time=2500,disable_bc=!1}={}){for(this.on=(name,fn)=>(((map,key,create_entry)=>{let set=map.get(key);return void 0===set&&map.set(key,set=create_entry()),set})(this.observers,name,(()=>new Set)).add(fn),fn),this.once=(name,fn)=>{const once_fn=(...args)=>{this.off(name,once_fn),fn(...args)};this.on(name,once_fn)},this.off=(name,fn)=>{const observers=this.observers.get(name);void 0!==observers&&(observers.delete(fn),0===observers.size&&this.observers.delete(name))};"/"===server_url[server_url.length-1];)server_url=server_url.slice(0,server_url.length-1);const encoded_params=url.V(params);this.observers=new Map,this.max_backoff_time=max_backoff_time,this.bc_channel=`${server_url}/${roomname}`,this.url=`${server_url}/${roomname}${0===encoded_params.length?"":"?"+encoded_params}`,this.roomname=roomname,this.doc=doc,this.ws_polyfill=ws_polyfill,this.awareness=awareness,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disable_bc=disable_bc,this.ws_unsuccessful_reconnects=0,this.message_handlers=MESSAGE_HANDLERS.slice(),this._synced=!1,this.ws=null,this.ws_last_message_received=0,this.should_connect=connect,this.resync_interval=0,resync_interval>0&&(this.resync_interval=setInterval((()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const encoder=encoding.xv();encoding.zd(encoder,0),sync.ue(encoder,doc),this.ws.send(encoding.Fo(encoder))}}),resync_interval)),this.bc_subscriber=(data,origin)=>{if(origin!==this){const encoder=read_message(this,new Uint8Array(data),!1);encoding.Bw(encoder)>1&&(0,broadcastchannel.mk)(this.bc_channel,encoding.Fo(encoder),this)}},this.update_handler=(update,origin)=>{if(origin!==this){const encoder=encoding.xv();encoding.zd(encoder,0),sync.f7(encoder,update),broadcast_message(this,encoding.Fo(encoder))}},this.doc.on("update",this.update_handler),this.awareness_update_handler=({added,updated,removed})=>{const changed_clients=added.concat(updated).concat(removed),encoder=encoding.xv();encoding.zd(encoder,1),encoding.Gu(encoder,y_protocols_awareness.X3(awareness,changed_clients)),broadcast_message(this,encoding.Fo(encoder))},awareness.on("update",this.awareness_update_handler),this.check_interval=setInterval((()=>{var _this_ws;this.wsconnected&&3e4<Date.now()-this.ws_last_message_received&&(this.emit("stale",[]),null===(_this_ws=this.ws)||void 0===_this_ws||_this_ws.close())}),3e3),connect&&this.connect()}}const REALMS_ENDPOINT=__webpack_require__("./node_modules/process/browser.js").env.NEXT_PUBLIC_REALMS_ENDPOINT,create_ws_provider=(id,yjs_doc_map)=>{let doc=yjs_doc_map.get("main");return void 0===doc?(doc=new yjs.JA,yjs_doc_map.set("main",doc)):doc.load(),new WebsocketProvider(REALMS_ENDPOINT,id,doc,{connect:!1})};var clamp=__webpack_require__("./packages/ui/src/utils/clamp/clamp.ts");const SATURATION_BOUND=[0,100],LIGHTNESS_BOUND=[0,100],bound_hash_code=(num,range)=>"number"==typeof range?range:num%Math.abs(range[1]-range[0])+range[0],sanitize_range=(range,bound)=>{const[min,max]=bound;return"number"==typeof range?(0,clamp.q)(min,Math.abs(range),max):1===range.length||range[0]===range[1]?(0,clamp.q)(min,Math.abs(range[0]),max):[Math.abs((0,clamp.q)(min,range[0],max)),(0,clamp.q)(min,Math.abs(range[1]),max)]},get_user_color=(value,{saturation=[50,55],lightness=[50,60]}={},alpha=100)=>{const hash=Math.abs((str=>{const len=str.length;let hash=0;for(let i=0;i<len;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;return hash})(String(value)));return((h,s,l,a)=>{s/=100,l/=100;const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs(h/60%2-1)),m=l-c/2;let r=0,g=0,b=0,alpha="";return 0<=h&&h<60?(r=c,g=x,b=0):60<=h&&h<120?(r=x,g=c,b=0):120<=h&&h<180?(r=0,g=c,b=x):180<=h&&h<240?(r=0,g=x,b=c):240<=h&&h<300?(r=x,g=0,b=c):300<=h&&h<360&&(r=c,g=0,b=x),r=Math.round(255*(r+m)).toString(16),g=Math.round(255*(g+m)).toString(16),b=Math.round(255*(b+m)).toString(16),1===r.length&&(r="0"+r),1===g.length&&(g="0"+g),1===b.length&&(b="0"+b),100!==a&&(alpha=Math.round(a/100*255).toString(16),1===alpha.length&&(alpha="0"+alpha)),`#${r}${g}${b}${alpha}`})(bound_hash_code(hash,[0,360]),bound_hash_code(hash,sanitize_range(saturation,SATURATION_BOUND)),bound_hash_code(hash,sanitize_range(lightness,LIGHTNESS_BOUND)),alpha)},CollaborationContext=react.createContext({client_id:0,is_collab_active:!1,yjs_doc_map:new Map,color_bg:"",color_fg:"",name:"",role:"viewer",user_id:"",avatar_id:null,avatar_hex:null}),set_if_defined=(context,key,value)=>{void 0!==value&&(context[key]=value)},collaboration=({id,provider_factory=create_ws_provider,should_bootstrap,excluded_properties,role,awareness_data})=>{const user=(0,hooks.m)(selectors.n1)||{},local_state=react.useMemo((()=>{const color_bg=get_user_color(user.id),color_fg=invert_min_default()(color_bg,!0);return{name:user.name,user_id:user.id,role,color_bg,color_fg,avatar_id:user.avatar_id,avatar_hex:user.avatar_hex,selection_color:get_user_color(user.id,void 0,35),cursor_type:"default",awareness_data}}),[awareness_data,role,user.id,user.name,user.avatar_id,user.avatar_hex]),[editor]=(0,LexicalComposerContext_prod.DF)(),collab_context=(({name,color_fg,color_bg,role,user_id,avatar_id,avatar_hex})=>{const context=react.useContext(CollaborationContext);return set_if_defined(context,"user_id",user_id),set_if_defined(context,"role",role),set_if_defined(context,"name",name),set_if_defined(context,"color_bg",color_bg),set_if_defined(context,"color_fg",color_fg),set_if_defined(context,"avatar_id",avatar_id),set_if_defined(context,"avatar_hex",avatar_hex),context})(local_state),{yjs_doc_map}=collab_context,provider=react.useMemo((()=>provider_factory(id,yjs_doc_map)),[id,provider_factory,yjs_doc_map]),[cursors,binding]=use_yjs_collaboration({provider,doc_map:yjs_doc_map,should_bootstrap:(null==window.parent||window.parent.frames.right!==window)&&should_bootstrap,excluded_properties,role,local_state});return use_yjs_history(editor,binding),((editor,provider,local_state)=>{react.useEffect((()=>(0,LexicalUtils_prod.Sd)(editor.registerCommand(Lexical_prod.$7,(()=>(set_local_state_focus({...local_state,provider,focusing:!0,awareness_data:local_state.awareness_data||{}}),!1)),Lexical_prod.jZ),editor.registerCommand(Lexical_prod.pF,(()=>(set_local_state_focus({...local_state,provider,focusing:!1,awareness_data:local_state.awareness_data||{}}),!1)),Lexical_prod.jZ))),[local_state,editor,provider])})(editor,provider,local_state),react.useEffect((()=>(collab_context.is_collab_active=!0,()=>{null==editor._parentEditor&&(collab_context.is_collab_active=!1)})),[collab_context,editor]),collab_context.client_id=binding.client_id,cursors}}}]);