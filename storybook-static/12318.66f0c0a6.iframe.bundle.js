"use strict";(self.webpackChunk_storiny_monorepo=self.webpackChunk_storiny_monorepo||[]).push([[12318],{"./packages/editor/src/plugins/draggable-block/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>draggable_block});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),LexicalComposerContext_prod=__webpack_require__("./node_modules/@lexical/react/LexicalComposerContext.prod.mjs"),LexicalUtils_prod=__webpack_require__("./node_modules/@lexical/utils/LexicalUtils.prod.mjs"),clsx_m=__webpack_require__("./node_modules/clsx/dist/clsx.m.js"),Lexical_prod=__webpack_require__("./node_modules/lexical/Lexical.prod.mjs"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),react_dom=__webpack_require__("./node_modules/next/dist/compiled/react-dom/index.js"),use_media_query=__webpack_require__("./packages/ui/src/hooks/use-media-query/index.ts"),grip=__webpack_require__("./packages/ui/src/icons/grip/index.tsx"),breakpoints=__webpack_require__("./packages/ui/src/theme/breakpoints.ts"),main_module=__webpack_require__("./packages/ui/src/theme/main.module.scss");const is_html_element=element=>element instanceof HTMLElement;class Point{get x(){return this._x}get y(){return this._y}equals({x,y}){return this.x===x&&this.y===y}calc_delta_x_to({x}){return this.x-x}calc_delta_y_to({y}){return this.y-y}calc_horizontal_distance_to(point){return Math.abs(this.calc_delta_x_to(point))}calc_vertical_distance(point){return Math.abs(this.calc_delta_y_to(point))}calc_distance_to(point){return Math.sqrt(Math.pow(this.calc_delta_x_to(point),2)+Math.pow(this.calc_delta_y_to(point),2))}constructor(x,y){this._x=x,this._y=y}}class Rect{static from_ltrb(left,top,right,bottom){return new Rect(left,top,right,bottom)}static from_lwth(left,width,top,height){return new Rect(left,top,left+width,top+height)}static from_points(start_point,end_point){const{y:top,x:left}=start_point,{y:bottom,x:right}=end_point;return Rect.from_ltrb(left,top,right,bottom)}static from_dom(dom){const{top,width,left,height}=dom.getBoundingClientRect();return Rect.from_lwth(left,width,top,height)}get top(){return this._top}get right(){return this._right}get bottom(){return this._bottom}get left(){return this._left}get width(){return Math.abs(this._left-this._right)}get height(){return Math.abs(this._bottom-this._top)}equals({top,left,bottom,right}){return top===this._top&&bottom===this._bottom&&left===this._left&&right===this._right}contains(target){if(target instanceof Point){const{x,y}=target,is_on_top_side=y<this._top,is_on_bottom_side=y>this._bottom,is_on_left_side=x<this._left,is_on_right_side=x>this._right;return{reason:{is_on_bottom_side,is_on_left_side,is_on_right_side,is_on_top_side},result:!(is_on_top_side||is_on_bottom_side||is_on_left_side||is_on_right_side)}}{const{top,left,bottom,right}=target;return top>=this._top&&top<=this._bottom&&bottom>=this._top&&bottom<=this._bottom&&left>=this._left&&left<=this._right&&right>=this._left&&right<=this._right}}intersects_with(rect){const{left:x1,top:y1,width:w1,height:h1}=rect,{left:x2,top:y2,width:w2,height:h2}=this;return(x1+w1>=x2+w2?x1+w1:x2+w2)-(x1<=x2?x1:x2)<=w1+w2&&(y1+h1>=y2+h2?y1+h1:y2+h2)-(y1<=y2?y1:y2)<=h1+h2}generate_new_rect({left=this.left,top=this.top,right=this.right,bottom=this.bottom}){return new Rect(left,top,right,bottom)}constructor(left,top,right,bottom){const[_top,_bottom]=top<=bottom?[top,bottom]:[bottom,top],[_left,_right]=left<=right?[left,right]:[right,left];this._top=_top,this._right=_right,this._left=_left,this._bottom=_bottom}}var rich_text=__webpack_require__("./packages/editor/src/plugins/rich-text/rich-text.ts"),injectStylesIntoStyleTag=__webpack_require__("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),styleDomAPI=__webpack_require__("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),styleDomAPI_default=__webpack_require__.n(styleDomAPI),insertBySelector=__webpack_require__("./node_modules/style-loader/dist/runtime/insertBySelector.js"),insertBySelector_default=__webpack_require__.n(insertBySelector),setAttributesWithoutAttributes=__webpack_require__("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),setAttributesWithoutAttributes_default=__webpack_require__.n(setAttributesWithoutAttributes),insertStyleElement=__webpack_require__("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),insertStyleElement_default=__webpack_require__.n(insertStyleElement),styleTagTransform=__webpack_require__("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),styleTagTransform_default=__webpack_require__.n(styleTagTransform),draggable_block_module=__webpack_require__("./node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[14].use[1]!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[14].use[3]!./packages/editor/src/plugins/draggable-block/draggable-block.module.scss"),options={};options.styleTagTransform=styleTagTransform_default(),options.setAttributes=setAttributesWithoutAttributes_default(),options.insert=insertBySelector_default().bind(null,"head"),options.domAPI=styleDomAPI_default(),options.insertStyleElement=insertStyleElement_default();injectStylesIntoStyleTag_default()(draggable_block_module.A,options);const draggable_block_draggable_block_module=draggable_block_module.A&&draggable_block_module.A.locals?draggable_block_module.A.locals:void 0;let prev_index=1/0;const get_margin=(element,margin)=>element?parseFloat(window.getComputedStyle(element)[margin]):0,get_collapsed_margins=element=>{const{marginTop:margin_top,marginBottom:margin_bottom}=window.getComputedStyle(element),prev_elem_sibling_margin_bottom=get_margin(element.previousElementSibling,"marginBottom"),next_elem_sibling_margin_top=get_margin(element.nextElementSibling,"marginTop"),collapsed_top_margin=Math.max(parseFloat(margin_top),prev_elem_sibling_margin_bottom);return{margin_bottom:Math.max(parseFloat(margin_bottom),next_elem_sibling_margin_top),margin_top:collapsed_top_margin}},get_block_element=(anchor_element,editor,event,use_edge_as_default=!1)=>{const anchor_element_rect=anchor_element.getBoundingClientRect(),top_level_node_keys=(editor=>editor.getEditorState().read((()=>(0,Lexical_prod.Ni)().getChildrenKeys())))(editor);let block_element=null;return editor.getEditorState().read((()=>{if(use_edge_as_default){const[first_node,last_node]=[editor.getElementByKey(top_level_node_keys[0]),editor.getElementByKey(top_level_node_keys[top_level_node_keys.length-1])],[first_node_rect,last_node_rect]=[null==first_node?void 0:first_node.getBoundingClientRect(),null==last_node?void 0:last_node.getBoundingClientRect()];if(first_node_rect&&last_node_rect&&(event.y<first_node_rect.top?block_element=first_node:event.y>last_node_rect.bottom&&(block_element=last_node),block_element))return}let index=0===(keys_length=top_level_node_keys.length)?1/0:prev_index>=0&&prev_index<keys_length?prev_index:Math.floor(keys_length/2);var keys_length;let direction=0;for(;index>=0&&index<top_level_node_keys.length;){const key=top_level_node_keys[index],element=editor.getElementByKey(key);if(null===element)break;const point=new Point(event.x,event.y),dom_rect=Rect.from_dom(element),{margin_top,margin_bottom}=get_collapsed_margins(element),rect=dom_rect.generate_new_rect({bottom:dom_rect.bottom+margin_bottom,left:anchor_element_rect.left,right:anchor_element_rect.right,top:dom_rect.top-margin_top}),{result,reason:{is_on_top_side,is_on_bottom_side}}=rect.contains(point);if(result){block_element=element,prev_index=index;break}0===direction&&(direction=is_on_top_side?-1:is_on_bottom_side?1:1/0),index+=direction}})),block_element},is_block_node=target_element=>"true"===target_element.getAttribute("data-lexical-decorator")&&"hr"!==target_element.nodeName.toLowerCase()||"figure"===target_element.nodeName.toLowerCase(),draggable_block=()=>{var _document_querySelector;const[editor]=(0,LexicalComposerContext_prod.DF)(),is_editable=editor._editable,anchor_element=null===(_document_querySelector=document.querySelector("div[data-editor-content]"))||void 0===_document_querySelector?void 0:_document_querySelector.parentElement,scroller_element=null==anchor_element?void 0:anchor_element.parentElement,is_smaller_than_mobile=(0,use_media_query.A)(breakpoints.L.down("mobile")),dragger_ref=react.useRef(null),target_line_ref=react.useRef(null),is_dragging_block_ref=react.useRef(!1),[draggable_block_element,set_draggable_block_element]=react.useState(null);react.useEffect((()=>{const on_mouse_move=event=>{const target=event.target;anchor_element&&is_html_element(target)?target.closest(`.${draggable_block_draggable_block_module.dragger}`)||set_draggable_block_element(get_block_element(anchor_element,editor,event)):set_draggable_block_element(null)},on_mouse_leave=()=>{set_draggable_block_element(null)};return null==scroller_element||scroller_element.addEventListener("mousemove",on_mouse_move),null==scroller_element||scroller_element.addEventListener("mouseleave",on_mouse_leave),()=>{null==scroller_element||scroller_element.removeEventListener("mousemove",on_mouse_move),null==scroller_element||scroller_element.removeEventListener("mouseleave",on_mouse_leave)}}),[scroller_element,anchor_element,editor]),react.useEffect((()=>{anchor_element&&dragger_ref.current&&((target_element,floating_element,anchor_element)=>{if(!target_element)return void(floating_element.style.opacity="0");const target_rect=target_element.getBoundingClientRect(),target_style=window.getComputedStyle(target_element),floating_element_rect=floating_element.getBoundingClientRect(),anchor_element_rect=anchor_element.getBoundingClientRect(),top=target_rect.top+(parseInt(target_style.lineHeight,10)-floating_element_rect.height)/2-anchor_element_rect.top-(is_block_node(target_element)?floating_element_rect.height+12:0);floating_element.style.opacity="1",floating_element.style.transform=`translate(4px, ${top}px)`})(draggable_block_element,dragger_ref.current,anchor_element)}),[anchor_element,draggable_block_element]),react.useEffect((()=>{const on_dragover=event=>{if(!anchor_element||!is_dragging_block_ref.current)return!1;const[is_file_transfer]=(0,rich_text.ZV)(event);if(is_file_transfer)return!1;const{pageY:page_y,target}=event;if(!is_html_element(target))return!1;const target_block_element=get_block_element(anchor_element,editor,event,!0),target_line_element=target_line_ref.current;return null!==target_block_element&&null!==target_line_element&&(((target_line_element,target_block_element,mouse_y,anchor_element)=>{const{top:target_block_element_top,height:target_block_element_height}=target_block_element.getBoundingClientRect(),{top:anchor_top,width:anchor_width}=anchor_element.getBoundingClientRect(),{margin_top,margin_bottom}=get_collapsed_margins(target_block_element);let line_top=target_block_element_top;mouse_y>=target_block_element_top?line_top+=target_block_element_height+margin_bottom/2:line_top-=margin_top/2;const top=line_top-anchor_top-2.5;target_line_element.style.transform=`translate(24px, ${top}px)`,target_line_element.style.width=anchor_width-48+"px",target_line_element.style.opacity="0.5"})(target_line_element,target_block_element,page_y,anchor_element),event.preventDefault(),!0)};return(0,LexicalUtils_prod.Sd)(editor.registerCommand(Lexical_prod.ri,(event=>on_dragover(event)),Lexical_prod.Ac),editor.registerCommand(Lexical_prod.Sr,(event=>(event=>{if(!anchor_element||!is_dragging_block_ref.current)return!1;const[is_file_transfer]=(0,rich_text.ZV)(event);if(is_file_transfer)return!1;const{target,dataTransfer:data_transfer,pageY:page_y}=event,drag_data=(null==data_transfer?void 0:data_transfer.getData("application/x-storiny-drag-data"))||"",dragged_node=(0,Lexical_prod.ns)(drag_data);if(!dragged_node)return!1;if(!is_html_element(target))return!1;const target_block_element=get_block_element(anchor_element,editor,event,!0);if(!target_block_element)return!1;const target_node=(0,Lexical_prod.xL)(target_block_element);return!!target_node&&(target_node===dragged_node||(page_y>=target_block_element.getBoundingClientRect().top?target_node.insertAfter(dragged_node):target_node.insertBefore(dragged_node),set_draggable_block_element(null)),!0)})(event)),Lexical_prod.Wg))}),[anchor_element,editor]);return!anchor_element||is_smaller_than_mobile?null:(0,react_dom.createPortal)((0,jsx_runtime.jsxs)(react.Fragment,{children:[(0,jsx_runtime.jsx)("div",{"aria-hidden":"true",className:(0,clsx_m.$)(main_module.A["flex-center"],draggable_block_draggable_block_module.dragger),draggable:!0,onDragEnd:()=>{var target_line_element;is_dragging_block_ref.current=!1,(target_line_element=target_line_ref.current)&&(target_line_element.style.opacity="0")},onDragStart:event=>{const data_transfer=event.dataTransfer;if(!data_transfer||!draggable_block_element)return;((data_transfer,draggable_block_element)=>{const{transform}=draggable_block_element.style;draggable_block_element.style.transform="translateZ(0)",data_transfer.setDragImage(draggable_block_element,is_block_node(draggable_block_element)?draggable_block_element.getBoundingClientRect().left:0,0),setTimeout((()=>{draggable_block_element.style.transform=transform}))})(data_transfer,draggable_block_element);let node_key="";editor.update((()=>{const node=(0,Lexical_prod.xL)(draggable_block_element);node&&(node_key=node.getKey())})),is_dragging_block_ref.current=!0,data_transfer.setData("application/x-storiny-drag-data",node_key)},ref:dragger_ref,children:is_editable?(0,jsx_runtime.jsx)(grip.A,{className:draggable_block_draggable_block_module.icon}):null}),(0,jsx_runtime.jsx)("div",{"aria-hidden":"true",className:draggable_block_draggable_block_module["target-line"],ref:target_line_ref})]}),anchor_element)}},"./packages/ui/src/icons/grip/index.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),_utils_create_svg_icon__WEBPACK_IMPORTED_MODULE_2__=(__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),__webpack_require__("./packages/ui/src/utils/create-svg-icon/create-svg-icon.tsx"));const GripIcon=(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("path",{d:"M4 2.5a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0ZM4 6a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0ZM4 9.5a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0ZM7 2.5a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0ZM7 6a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0ZM7 9.5a.5.5 0 1 0 1 0 .5.5 0 0 0-1 0Z"}),__WEBPACK_DEFAULT_EXPORT__=(0,_utils_create_svg_icon__WEBPACK_IMPORTED_MODULE_2__.S)(GripIcon,"grip")},"./node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[14].use[1]!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[14].use[3]!./packages/editor/src/plugins/draggable-block/draggable-block.module.scss":(module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/css-loader/dist/runtime/sourceMaps.js"),_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__),_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/css-loader/dist/runtime/api.js"),___CSS_LOADER_EXPORT___=__webpack_require__.n(_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__)()(_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default());___CSS_LOADER_EXPORT___.push([module.id,".v7XYCG1A7rQrFiYeOPYx{--icon-size: 16px;--icon-stroke: var(--inverted-negative);opacity:.5;pointer-events:none}._aZSVgfsDwrDpN4j9yGF{position:absolute;left:0;top:0;padding:4px 1px;cursor:grab;opacity:0;border-radius:var(--radius-sm);z-index:calc(var(--z-index-header) - 1);will-change:transform}._aZSVgfsDwrDpN4j9yGF:hover{background-color:var(--inverted-50)}._aZSVgfsDwrDpN4j9yGF:active{cursor:grabbing}._aZSVgfsDwrDpN4j9yGF:hover .v7XYCG1A7rQrFiYeOPYx,._aZSVgfsDwrDpN4j9yGF:active .v7XYCG1A7rQrFiYeOPYx{opacity:1}.kZBnNozfJ5KoenpRiABr{pointer-events:none;background:var(--inverted-400);height:5px;border-radius:3px;position:absolute;left:0;top:0;opacity:0;will-change:transform}","",{version:3,sources:["webpack://./packages/editor/src/plugins/draggable-block/draggable-block.module.scss"],names:[],mappings:"AAAA,sBACE,iBAAA,CACA,uCAAA,CAEA,UAAA,CACA,mBAAA,CAGF,sBACE,iBAAA,CACA,MAAA,CACA,KAAA,CACA,eAAA,CACA,WAAA,CACA,SAAA,CACA,8BAAA,CACA,uCAAA,CACA,qBAAA,CAEA,4BACE,mCAAA,CAGF,6BACE,eAAA,CAKA,qGACE,SAAA,CAKN,sBACE,mBAAA,CACA,8BAAA,CACA,UAAA,CACA,iBAAA,CACA,iBAAA,CACA,MAAA,CACA,KAAA,CACA,SAAA,CACA,qBAAA",sourcesContent:[".icon {\n  --icon-size: 16px;\n  --icon-stroke: var(--inverted-negative);\n\n  opacity: 0.5;\n  pointer-events: none;\n}\n\n.dragger {\n  position: absolute;\n  left: 0;\n  top: 0;\n  padding: 4px 1px;\n  cursor: grab;\n  opacity: 0;\n  border-radius: var(--radius-sm);\n  z-index: calc(var(--z-index-header) - 1);\n  will-change: transform;\n\n  &:hover {\n    background-color: var(--inverted-50);\n  }\n\n  &:active {\n    cursor: grabbing;\n  }\n\n  &:hover,\n  &:active {\n    & .icon {\n      opacity: 1;\n    }\n  }\n}\n\n.target-line {\n  pointer-events: none;\n  background: var(--inverted-400);\n  height: 5px;\n  border-radius: 3px;\n  position: absolute;\n  left: 0;\n  top: 0;\n  opacity: 0;\n  will-change: transform;\n}\n"],sourceRoot:""}]),___CSS_LOADER_EXPORT___.locals={icon:"v7XYCG1A7rQrFiYeOPYx",dragger:"_aZSVgfsDwrDpN4j9yGF","target-line":"kZBnNozfJ5KoenpRiABr"};const __WEBPACK_DEFAULT_EXPORT__=___CSS_LOADER_EXPORT___}}]);