import crypto from"crypto";let ImageSize=function(ImageSize){return ImageSize[ImageSize.W_64=64]="W_64",ImageSize[ImageSize.W_128=128]="W_128",ImageSize[ImageSize.W_320=320]="W_320",ImageSize[ImageSize.W_640=640]="W_640",ImageSize[ImageSize.W_960=960]="W_960",ImageSize[ImageSize.W_1200=1200]="W_1200",ImageSize[ImageSize.W_1440=1440]="W_1440",ImageSize[ImageSize.W_1920=1920]="W_1920",ImageSize[ImageSize.W_2440=2440]="W_2440",ImageSize}({});const VALID_SIZES=Object.values(ImageSize).filter(value=>"number"==typeof value).join("|"),NATIVE_REGEX=new RegExp(`\\/(?:(uploads|dl)\\/)?(?:(w@(?:auto|${VALID_SIZES}))\\/)?((?!uploads|dl)[\\/a-zA-Z0-9._-]+)$`),REMOTE_REGEX=new RegExp(`\\/remote\\/(?:(w@(?:auto|${VALID_SIZES}))\\/)?([a-zA-Z0-9_-]+)\\/([a-zA-Z0-9._-]+)$`),decode_hex=encoded=>{let i,j;var ref;if(encoded&&encoded.length&&encoded.length%2==0&&!encoded.match(/[^\da-f]/)){var buffer=Buffer.alloc(encoded.length/2);for(i=j=0,ref=encoded.length;j<ref;i=j+=2)buffer[i/2]=Number.parseInt(encoded.slice(i,+(i+1)+1||9e9),16);return buffer.toString()}return null},get_width=function(segment){return(segment=void 0===segment?"":segment).substring(2)},verify=(digest,decoded_url,key)=>{try{var hmac=crypto.createHmac("sha1",key||process.env.PROXY_KEY);if(hmac.update(decoded_url,"utf8"),hmac.digest("hex")===digest)return!0}catch(_unused){}return!1},BASE_BUCKET="s3://base-3939361a",UPLOADS_BUCKET="s3://uploads-ec0f63c5",prepare_text_response=r=>r.headersOut["Content-Type"]="text/plain; charset=utf-8",pass_to_proxy=(r,path)=>{r.variables.proxy_rewrite=path,r.internalRedirect("@proxy_pass")},get_resize_option=parsed_width=>{parsed_width=get_width(parsed_width);return Boolean(parsed_width)&&"auto"!==parsed_width?`/resize:fit:${parsed_width}:0:0:0/extend_ar:false:ce:0:0/`:""},handler=r=>{try{var uri=r.uri||"";if("/"===uri)prepare_text_response(r),r.return(200,"Storiny media service");else if("/robots.txt"===uri)prepare_text_response(r),r.return(200,"User-agent: *\nDisallow: /$\nDisallow: /health\n");else{if("/health"===uri)return pass_to_proxy(r,"health");if(uri.startsWith("/remote")){var matches=REMOTE_REGEX.exec(uri);if(null!==matches){const parsed_width=matches[1],digest=matches[2],hex=matches[3];var decoded_url=decode_hex(hex);const resize_option=get_resize_option(parsed_width);return decoded_url&&verify(digest,decoded_url)?pass_to_proxy(r,`internal${resize_option||"/"}plain/`+decoded_url):(prepare_text_response(r),void r.return(400,"Invalid signature"))}}var req_type,resize_option,_ref=NATIVE_REGEX.exec(uri)||[],type=_ref[1],parsed_width=_ref[2],key=_ref[3];if(key)return/\/web-assets\/raw/.test(uri)?(r.headersOut["X-Robots-Tag"]="noindex",pass_to_proxy(r,`internal/plain/${BASE_BUCKET}/`+key)):(req_type=type,resize_option=get_resize_option(parsed_width),["uploads","dl"].includes(req_type)?pass_to_proxy(r,`internal${"dl"===type?"/return_attachment:true/":resize_option||"/"}plain/${UPLOADS_BUCKET}/`+key):(r.headersOut["X-Robots-Tag"]="noindex",pass_to_proxy(r,`internal${resize_option||"/"}plain/${BASE_BUCKET}/`+key)));prepare_text_response(r),r.return(400,"Invalid or missing media key")}}catch(_unused){prepare_text_response(r),r.return(500,"Internal server error")}};var index={handler:handler};export{index as default};
