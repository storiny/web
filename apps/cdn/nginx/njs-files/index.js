import crypto from"crypto";let ImageSize=function(ImageSize){return ImageSize[ImageSize.W_24=24]="W_24",ImageSize[ImageSize.W_32=32]="W_32",ImageSize[ImageSize.W_64=64]="W_64",ImageSize[ImageSize.W_128=128]="W_128",ImageSize[ImageSize.W_256=256]="W_256",ImageSize[ImageSize.W_320=320]="W_320",ImageSize[ImageSize.W_640=640]="W_640",ImageSize[ImageSize.W_860=860]="W_860",ImageSize[ImageSize.W_1024=1024]="W_1024",ImageSize[ImageSize.W_1440=1440]="W_1440",ImageSize[ImageSize.W_1920=1920]="W_1920",ImageSize[ImageSize.W_2048=2048]="W_2048",ImageSize}({});const validSizes=Object.values(ImageSize).filter(value=>"number"==typeof value).join("|"),NATIVE_REGEX=new RegExp(`\\/(?:(uploads|dl)\\/)?(?:(w@(?:auto|${validSizes}))\\/)?((?!uploads|dl)[\\/a-zA-Z0-9_-]+)$`),REMOTE_REGEX=new RegExp(`\\/remote\\/(?:(w@(?:auto|${validSizes}))\\/)?([a-zA-Z0-9_-]+)\\/([a-zA-Z0-9_-]+)$`),decodeHex=encoded=>{let i,j;var ref;if(encoded&&encoded.length&&encoded.length%2==0&&!encoded.match(/[^\da-f]/)){var buffer=Buffer.alloc(encoded.length/2);for(i=j=0,ref=encoded.length;j<ref;i=j+=2)buffer[i/2]=Number.parseInt(encoded.slice(i,+(i+1)+1||9e9),16);return buffer.toString()}return null},getWidth=function(segment){return(segment=void 0===segment?"":segment).substring(2)},verify=(digest,decodedUrl,key)=>{try{var hmac=crypto.createHmac("sha1",key||process.env.PROXY_KEY);if(hmac.update(decodedUrl,"utf8"),hmac.digest("hex")===digest)return!0}catch(e){}return!1},baseBucket="s3://base",uploadsBucket="s3://uploads",prepareTextResponse=r=>r.headersOut["Content-Type"]="text/plain; charset=utf-8",passToProxy=(r,path)=>{r.variables.proxy_rewrite=path,r.internalRedirect("@proxy_pass")},getResizeOption=parsedWidth=>{parsedWidth=getWidth(parsedWidth);return Boolean(parsedWidth)&&"auto"!==parsedWidth?`/resize:fit:${parsedWidth}:0:0:0/extend_ar:false:ce:0:0/`:""},handler=r=>{try{var uri=r.uri||"";if(uri.startsWith("/remote")&&REMOTE_REGEX.test(uri)){const _ref=REMOTE_REGEX.exec(uri)||[],parsedWidth=_ref[1],digest=_ref[2],hex=_ref[3];var decodedUrl=decodeHex(hex);const resizeOption=getResizeOption(parsedWidth);return decodedUrl&&verify(digest,decodedUrl)?passToProxy(r,`internal${resizeOption||"/"}plain/`+decodedUrl):(prepareTextResponse(r),void r.return(400,"Invalid signature"))}var reqType,resizeOption,_ref2=NATIVE_REGEX.exec(uri)||[],type=_ref2[1],parsedWidth=_ref2[2],key=_ref2[3];if(key)return reqType=type,resizeOption=getResizeOption(parsedWidth),["uploads","dl"].includes(reqType)?passToProxy(r,`internal${"dl"===type?"/return_attachment:true/":resizeOption||"/"}plain/${uploadsBucket}/`+key):passToProxy(r,`internal${resizeOption||"/"}plain/${baseBucket}/`+key);prepareTextResponse(r),r.return(400,"Invalid or missing media key")}catch(e){prepareTextResponse(r),r.return(500,"Internal server error")}};var index={handler:handler};export{index as default};
