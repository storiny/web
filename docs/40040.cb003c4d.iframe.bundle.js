"use strict";(self.webpackChunk_storiny_monorepo=self.webpackChunk_storiny_monorepo||[]).push([[40040],{"./packages/editor/src/nodes/code-block/component/editor/extensions/editable/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{get_editable_extensions:()=>get_editable_extensions});var dist=__webpack_require__("./node_modules/@codemirror/autocomplete/dist/index.js"),commands_dist=__webpack_require__("./node_modules/@codemirror/commands/dist/index.js"),language_dist=__webpack_require__("./node_modules/@codemirror/language/dist/index.js"),lint_dist=__webpack_require__("./node_modules/@codemirror/lint/dist/index.js"),search_dist=__webpack_require__("./node_modules/@codemirror/search/dist/index.js"),state_dist=__webpack_require__("./node_modules/@codemirror/state/dist/index.js"),view_dist=__webpack_require__("./node_modules/@codemirror/view/dist/index.js"),Lexical_prod=__webpack_require__("./node_modules/lexical/Lexical.prod.mjs"),clsx_m=__webpack_require__("./node_modules/clsx/dist/clsx.m.js"),yjs=__webpack_require__("./node_modules/yjs/dist/yjs.mjs"),main_module=__webpack_require__("./packages/ui/src/theme/main.module.scss"),styles_module=__webpack_require__("./packages/editor/src/utils/sync-cursor-positions/styles.module.scss"),injectStylesIntoStyleTag=__webpack_require__("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),styleDomAPI=__webpack_require__("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),styleDomAPI_default=__webpack_require__.n(styleDomAPI),insertBySelector=__webpack_require__("./node_modules/style-loader/dist/runtime/insertBySelector.js"),insertBySelector_default=__webpack_require__.n(insertBySelector),setAttributesWithoutAttributes=__webpack_require__("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),setAttributesWithoutAttributes_default=__webpack_require__.n(setAttributesWithoutAttributes),insertStyleElement=__webpack_require__("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),insertStyleElement_default=__webpack_require__.n(insertStyleElement),styleTagTransform=__webpack_require__("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),styleTagTransform_default=__webpack_require__.n(styleTagTransform),code_block_styles_module=__webpack_require__("./node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[14].use[1]!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[14].use[3]!./packages/editor/src/collaboration/code-block/styles.module.scss"),options={};options.styleTagTransform=styleTagTransform_default(),options.setAttributes=setAttributesWithoutAttributes_default(),options.insert=insertBySelector_default().bind(null,"head"),options.domAPI=styleDomAPI_default(),options.insertStyleElement=insertStyleElement_default();injectStylesIntoStyleTag_default()(code_block_styles_module.A,options);const collaboration_code_block_styles_module=code_block_styles_module.A&&code_block_styles_module.A.locals?code_block_styles_module.A.locals:void 0;class YRange{static from_json(json){return new YRange((0,yjs.sH)(json.yanchor),(0,yjs.sH)(json.yhead))}toJSON(){return{yanchor:(0,yjs.TB)(this.yanchor),yhead:(0,yjs.TB)(this.yhead)}}constructor(yanchor,yhead){this.yanchor=yanchor,this.yhead=yhead}}class YSyncConfig{to_y_pos(pos,assoc=0){return(0,yjs.SF)(this.ytext,pos,assoc)}from_y_pos(rpos){const pos=(0,yjs.IT)((0,yjs.sH)(rpos),this.ytext.doc);if(null==pos||pos.type!==this.ytext)throw new Error("[code-block] The position to retrieve was created by a different document");return{pos:pos.index,assoc:pos.assoc}}to_y_range(range){const assoc=range.assoc,yanchor=this.to_y_pos(range.anchor,assoc),yhead=this.to_y_pos(range.head,assoc);return new YRange(yanchor,yhead)}from_y_range(yrange){const anchor=this.from_y_pos(yrange.yanchor),head=this.from_y_pos(yrange.yhead);return anchor.pos===head.pos?state_dist.OF.cursor(head.pos,head.assoc):state_dist.OF.range(anchor.pos,head.pos)}constructor(ytext,awareness){this.ytext=ytext,this.awareness=awareness}}const code_block_sync_facet=state_dist.sj.define({combine:inputs=>inputs[inputs.length-1]}),code_block_sync_annotation=state_dist.YH.define();const code_block_sync=view_dist.Z9.fromClass(class YSyncPluginValue{observer(event,tr){if(tr.origin!==this.conf){const delta=event.delta,changes=[];let pos=0;for(let i=0;i<delta.length;i++){const d=delta[i];null!=d.insert?changes.push({from:pos,to:pos,insert:d.insert}):null!=d.delete?(changes.push({from:pos,to:pos+d.delete,insert:""}),pos+=d.delete):pos+=d.retain||0}this.view.dispatch({changes,annotations:[code_block_sync_annotation.of(this.conf)]})}}update(update){var _ytext_doc;if(!update.docChanged||update.transactions.length>0&&update.transactions[0].annotation(code_block_sync_annotation)===this.conf)return;const ytext=this.conf.ytext;null===(_ytext_doc=ytext.doc)||void 0===_ytext_doc||_ytext_doc.transact((()=>{let adj=0;update.changes.iterChanges(((from_a,to_a,_,__,insert)=>{const insert_text=insert.sliceString(0,insert.length,"\n");from_a!==to_a&&ytext.delete(from_a+adj,to_a-from_a),insert_text.length>0&&ytext.insert(from_a+adj,insert_text),adj+=insert_text.length-(to_a-from_a)}))}),this.conf)}destroy(){this.ytext.unobserve(this.observer)}constructor(view){this.view=view,this.conf=view.state.facet(code_block_sync_facet),this.ytext=this.conf.ytext,this.observer=this.observer.bind(this),this.ytext.observe(this.observer)}});var process=__webpack_require__("./node_modules/process/browser.js");const code_block_remote_selections_annotation=state_dist.YH.define();class CodeBlockRemoteCaretWidget extends view_dist.xO{toDOM(){const caret=document.createElement("span");if(caret.className=collaboration_code_block_styles_module["selection-caret"],caret.style.setProperty("--color-bg",this.color_bg),caret.style.setProperty("--color-fg",this.color_fg),"mini"===this.type)caret.classList.add(collaboration_code_block_styles_module.mini);else{const name=document.createElement("span");name.textContent=this.name,name.className=(0,clsx_m.$)(main_module.A.ellipsis,styles_module.A.name,collaboration_code_block_styles_module.name),caret.appendChild(name)}return caret}eq(widget){return widget.color_bg===this.color_bg&&widget.type===this.type}compare(widget){return widget.color_bg===this.color_bg&&widget.type===this.type}updateDOM(){return!1}get estimatedHeight(){return-1}ignoreEvent(){return!0}constructor(name,color_fg,color_bg,type){super(),this.name=name,this.color_fg=color_fg,this.color_bg=color_bg,this.type=type}}const code_block_remote_selections=view_dist.Z9.fromClass(class YRemoteSelectionsPluginValue{listener({added,updated,removed}){added.concat(updated).concat(removed).findIndex((id=>{var _this_conf_awareness_doc,_this_conf_awareness;return id!==(null===(_this_conf_awareness=this.conf.awareness)||void 0===_this_conf_awareness||null===(_this_conf_awareness_doc=_this_conf_awareness.doc)||void 0===_this_conf_awareness_doc?void 0:_this_conf_awareness_doc.clientID)}))>=0&&this.view.dispatch({annotations:[code_block_remote_selections_annotation.of([])]})}destroy(){this.awareness&&this.awareness.off("change",this.listener)}update(update){const ytext=this.conf.ytext,ydoc=ytext.doc,awareness=this.conf.awareness;if("test"!==process.env.NEXT_PUBLIC_ENV&&awareness){const local_awareness_state=awareness.getLocalState();if(null!=local_awareness_state){const sel=update.view.hasFocus&&update.view.dom.ownerDocument.hasFocus()?update.state.selection.main:null,current_anchor=null==local_awareness_state.code_block_cursor?null:yjs.sH(local_awareness_state.code_block_cursor.anchor),current_head=null==local_awareness_state.code_block_cursor?null:yjs.sH(local_awareness_state.code_block_cursor.head);if(null!=sel){const anchor=yjs.SF(ytext,sel.anchor),head=yjs.SF(ytext,sel.head);null!=local_awareness_state.code_block_cursor&&yjs.uG(current_anchor,anchor)&&yjs.uG(current_head,head)||(awareness.setLocalStateField("focus_pos",null),awareness.setLocalStateField("anchor_pos",null),awareness.setLocalStateField("code_block_cursor",{anchor,head}))}else null!=local_awareness_state.code_block_cursor&&awareness.setLocalStateField("code_block_cursor",null)}const decorations=[],local_client_id=awareness.doc.clientID,awareness_states=awareness.getStates(),{cursor_type}=awareness_states.get(local_client_id)||{};awareness_states.forEach(((state,client_id)=>{if(client_id===local_client_id||"viewer"===state.role)return;const cursor=state.code_block_cursor;if(null==cursor||null==cursor.anchor||null==cursor.head)return;const anchor=yjs.IT(cursor.anchor,ydoc),head=yjs.IT(cursor.head,ydoc);if(null==anchor||null==head||anchor.type!==ytext||head.type!==ytext)return;const{name,color_bg,color_fg,selection_color}=state,start=Math.min(anchor.index,head.index),end=Math.max(anchor.index,head.index),start_line=update.view.state.doc.lineAt(start),end_line=update.view.state.doc.lineAt(end);if(start_line.number===end_line.number)decorations.push({from:start,to:end,value:view_dist.NZ.mark({attributes:{style:`background-color: ${selection_color}`},class:collaboration_code_block_styles_module.selection})});else{decorations.push({from:start,to:start_line.from+start_line.length,value:view_dist.NZ.mark({attributes:{style:`background-color: ${selection_color}`},class:collaboration_code_block_styles_module.selection})}),decorations.push({from:end_line.from,to:end,value:view_dist.NZ.mark({attributes:{style:`background-color: ${selection_color}`},class:collaboration_code_block_styles_module.selection})});for(let i=start_line.number+1;i<end_line.number;i++){const line_pos=update.view.state.doc.line(i).from;decorations.push({from:line_pos,to:line_pos,value:view_dist.NZ.line({attributes:{style:`background-color: ${selection_color}`,class:collaboration_code_block_styles_module["line-selection"]}})})}}decorations.push({from:head.index,to:head.index,value:view_dist.NZ.widget({side:head.index-anchor.index>0?-1:1,block:!1,widget:new CodeBlockRemoteCaretWidget(name,color_fg,color_bg,cursor_type)})})})),this.decorations=view_dist.NZ.set(decorations,!0)}}constructor(view){this.view=view,this.conf=view.state.facet(code_block_sync_facet),this.awareness=this.conf.awareness,this.decorations=state_dist.om.of([]),this.listener=this.listener.bind(this),this.awareness&&this.awareness.on("change",this.listener)}},{decorations:({decorations})=>decorations});class CodeBlockUndoManagerConfig{get_undo_manager(){return this.undo_manager}add_tracked_origin(origin){this.undo_manager.addTrackedOrigin(origin)}remove_tracked_origin(origin){this.undo_manager.removeTrackedOrigin(origin)}undo(){return null!=this.undo_manager.undo()}redo(){return null!=this.undo_manager.redo()}constructor(undo_manager){this.undo_manager=undo_manager}}const code_block_undo_manager_facet=state_dist.sj.define({combine:inputs=>inputs[inputs.length-1]});state_dist.YH.define();const code_block_undo_manager=view_dist.Z9.fromClass(class CodeBlockUndoManagerPluginValue{store_selection(){this.before_change_selection=this.sync_conf.to_y_range(this.view.state.selection.main)}on_stack_item_added({stackItem:stack_item,changedParentTypes:changed_parent_types}){changed_parent_types.has(this.sync_conf.ytext)&&this.before_change_selection&&!stack_item.meta.has(this)&&stack_item.meta.set(this,this.before_change_selection)}on_stack_item_popped({stackItem:stack_item}){const sel=stack_item.meta.get(this);if(sel){const selection=this.sync_conf.from_y_range(sel);this.view.dispatch(this.view.state.update({selection})),this.store_selection()}}update(update){!update.selectionSet||0!==update.transactions.length&&update.transactions[0].annotation(code_block_sync_annotation)===this.sync_conf||this.store_selection()}destroy(){this.undo_manager.off("stack-item-added",this.on_stack_item_added),this.undo_manager.off("stack-item-popped",this.on_stack_item_popped),this.undo_manager.removeTrackedOrigin(this.sync_conf)}constructor(view){this.view=view,this.conf=view.state.facet(code_block_undo_manager_facet),this.undo_manager=this.conf.get_undo_manager(),this.sync_conf=view.state.facet(code_block_sync_facet),this.before_change_selection=null,this.on_stack_item_added=this.on_stack_item_added.bind(this),this.on_stack_item_popped=this.on_stack_item_popped.bind(this),this.undo_manager.on("stack-item-added",this.on_stack_item_added),this.undo_manager.on("stack-item-popped",this.on_stack_item_popped),this.undo_manager.addTrackedOrigin(this.sync_conf)}});var code_block=__webpack_require__("./packages/editor/src/nodes/code-block/code-block.tsx");const get_editable_extensions=({content,awareness,undo_manager,editor,node_key,make_editor_editable})=>{const collab_extensions=[code_block_sync_facet.of(new YSyncConfig(content,awareness)),code_block_sync];return null!==awareness&&collab_extensions.push(code_block_remote_selections),null!==undo_manager&&collab_extensions.push(code_block_undo_manager_facet.of(new CodeBlockUndoManagerConfig(undo_manager)),code_block_undo_manager,view_dist.Lz.domEventHandlers({beforeinput:(event,view)=>{switch(event.inputType){case"historyUndo":return(({state})=>state.facet(code_block_undo_manager_facet).undo()||!0)(view);case"historyRedo":return(({state})=>state.facet(code_block_undo_manager_facet).redo()||!0)(view);case"deleteContentBackward":if(!view.state.doc.toString().length)return void editor.update((()=>{const node=(0,Lexical_prod.ns)(node_key);(0,code_block.im)(node)&&(node.remove(),make_editor_editable())}))}return!1}})),[...collab_extensions,(0,view_dist.VH)(),(0,view_dist.A)(),(0,language_dist.WD)(),(0,language_dist.SG)(),(0,dist.wm)(),(0,dist.yU)({closeOnBlur:!0}),(0,search_dist.gN)(),state_dist.$t.allowMultipleSelections.of(!0),view_dist.w4.of([commands_dist.Yc,...dist.Bc,...commands_dist.pw,...language_dist.f7,...dist.OO,...lint_dist.$w])]}},"./node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[14].use[1]!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[14].use[3]!./packages/editor/src/collaboration/code-block/styles.module.scss":(module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/css-loader/dist/runtime/sourceMaps.js"),_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__),_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/css-loader/dist/runtime/api.js"),___CSS_LOADER_EXPORT___=__webpack_require__.n(_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__)()(_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default());___CSS_LOADER_EXPORT___.push([module.id,'.ZwKFFpx6LG_cCmW7pBGc{pointer-events:none}.VJmnNaS4_tr3fTvR1KCp{padding:0}.LW8acTZmf8o7IcjDpYmo{display:inline;position:relative;width:0}.LW8acTZmf8o7IcjDpYmo::before{content:"";position:absolute;width:2px;height:100%;border-radius:0 0 2px 2px;background-color:var(--color-bg)}.LW8acTZmf8o7IcjDpYmo.FEoNOPmkgWcV2ebBHVEW::after{position:absolute;content:"";width:8px;height:8px;top:-8px;left:-3px;background-color:var(--color-bg);border-radius:50%}.gRIW5P3G56A_kN0aORAD{top:calc(-100% - 8px) !important}',"",{version:3,sources:["webpack://./packages/editor/src/collaboration/code-block/styles.module.scss"],names:[],mappings:"AAAA,sBACE,mBAAA,CAGF,sBACE,SAAA,CAGF,sBACE,cAAA,CACA,iBAAA,CACA,OAAA,CAEA,8BACE,UAAA,CACA,iBAAA,CACA,SAAA,CACA,WAAA,CACA,yBAAA,CACA,gCAAA,CAIA,kDACE,iBAAA,CACA,UAAA,CACA,SAAA,CACA,UAAA,CACA,QAAA,CACA,SAAA,CACA,gCAAA,CACA,iBAAA,CAKN,sBACE,gCAAA",sourcesContent:['.selection {\n  pointer-events: none;\n}\n\n.line-selection {\n  padding: 0;\n}\n\n.selection-caret {\n  display: inline;\n  position: relative;\n  width: 0;\n\n  &::before {\n    content: "";\n    position: absolute;\n    width: 2px;\n    height: 100%;\n    border-radius: 0 0 2px 2px;\n    background-color: var(--color-bg);\n  }\n\n  &.mini {\n    &::after {\n      position: absolute;\n      content: "";\n      width: 8px;\n      height: 8px;\n      top: -8px;\n      left: -3px;\n      background-color: var(--color-bg);\n      border-radius: 50%;\n    }\n  }\n}\n\n.name {\n  top: calc(-100% - 8px) !important;\n}\n'],sourceRoot:""}]),___CSS_LOADER_EXPORT___.locals={selection:"ZwKFFpx6LG_cCmW7pBGc","line-selection":"VJmnNaS4_tr3fTvR1KCp","selection-caret":"LW8acTZmf8o7IcjDpYmo",mini:"FEoNOPmkgWcV2ebBHVEW",name:"gRIW5P3G56A_kN0aORAD"};const __WEBPACK_DEFAULT_EXPORT__=___CSS_LOADER_EXPORT___}}]);